{{- if .Values.underwriter.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "underwriter.fullname" . }}
  namespace: {{ include "global.namespace" . }}
  labels:
    {{- include "underwriter.labels" (dict "context" . "component" .Values.underwriter.name "name" .Values.underwriter.name) | nindent 4 }}
data:
  # Application Settings
  ENV_NAME: {{ .Values.underwriter.configmap.ENV_NAME | default "production" | quote }}
  LOG_LEVEL: {{ .Values.underwriter.configmap.LOG_LEVEL | default "info" | quote }}
  SERVER_ADDRESS: {{ .Values.underwriter.configmap.SERVER_ADDRESS | default ":4017" | quote }}
  HTTP_BODY_LIMIT_BYTES: {{ .Values.underwriter.configmap.HTTP_BODY_LIMIT_BYTES | default "104857600" | quote }}

  # CORS Configuration
  CORS_ALLOWED_ORIGINS: {{ .Values.underwriter.configmap.CORS_ALLOWED_ORIGINS | default "*" | quote }}
  CORS_ALLOWED_METHODS: {{ .Values.underwriter.configmap.CORS_ALLOWED_METHODS | default "GET,POST,PUT,PATCH,DELETE,OPTIONS" | quote }}
  CORS_ALLOWED_HEADERS: {{ .Values.underwriter.configmap.CORS_ALLOWED_HEADERS | default "Origin,Content-Type,Accept,Authorization,X-Request-ID" | quote }}

  # TLS Configuration
  TLS_TERMINATED_UPSTREAM: {{ .Values.underwriter.configmap.TLS_TERMINATED_UPSTREAM | default "true" | quote }}

  # Tenancy
  DEFAULT_TENANT_ID: {{ .Values.underwriter.configmap.DEFAULT_TENANT_ID | default "11111111-1111-1111-1111-111111111111" | quote }}
  DEFAULT_TENANT_SLUG: {{ .Values.underwriter.configmap.DEFAULT_TENANT_SLUG | default "default" | quote }}

  # PostgreSQL Database
  POSTGRES_HOST: {{ .Values.underwriter.configmap.POSTGRES_HOST | default "underwriter-postgresql-primary" | quote }}
  POSTGRES_PORT: {{ .Values.underwriter.configmap.POSTGRES_PORT | default "5432" | quote }}
  POSTGRES_DB: {{ .Values.underwriter.configmap.POSTGRES_DB | default "underwriter" | quote }}
  POSTGRES_USER: {{ .Values.underwriter.configmap.POSTGRES_USER | default "underwriter" | quote }}
  POSTGRES_SSLMODE: {{ .Values.underwriter.configmap.POSTGRES_SSLMODE | default "disable" | quote }}
  MIGRATIONS_PATH: {{ .Values.underwriter.configmap.MIGRATIONS_PATH | default "migrations" | quote }}

  # PostgreSQL Connection Pool
  POSTGRES_MAX_OPEN_CONNS: {{ .Values.underwriter.configmap.POSTGRES_MAX_OPEN_CONNS | default "25" | quote }}
  POSTGRES_MAX_IDLE_CONNS: {{ .Values.underwriter.configmap.POSTGRES_MAX_IDLE_CONNS | default "5" | quote }}
  POSTGRES_CONN_MAX_LIFETIME_MINS: {{ .Values.underwriter.configmap.POSTGRES_CONN_MAX_LIFETIME_MINS | default "30" | quote }}
  POSTGRES_CONN_MAX_IDLE_TIME_MINS: {{ .Values.underwriter.configmap.POSTGRES_CONN_MAX_IDLE_TIME_MINS | default "5" | quote }}
  POSTGRES_CONNECT_TIMEOUT_SEC: {{ .Values.underwriter.configmap.POSTGRES_CONNECT_TIMEOUT_SEC | default "10" | quote }}

  # Redis
  REDIS_HOST: {{ .Values.underwriter.configmap.REDIS_HOST | default "underwriter-valkey-primary:6379" | quote }}
  REDIS_DB: {{ .Values.underwriter.configmap.REDIS_DB | default "0" | quote }}
  REDIS_PROTOCOL: {{ .Values.underwriter.configmap.REDIS_PROTOCOL | default "3" | quote }}
  REDIS_POOL_SIZE: {{ .Values.underwriter.configmap.REDIS_POOL_SIZE | default "10" | quote }}
  REDIS_MIN_IDLE_CONNS: {{ .Values.underwriter.configmap.REDIS_MIN_IDLE_CONNS | default "2" | quote }}
  REDIS_READ_TIMEOUT_MS: {{ .Values.underwriter.configmap.REDIS_READ_TIMEOUT_MS | default "3000" | quote }}
  REDIS_WRITE_TIMEOUT_MS: {{ .Values.underwriter.configmap.REDIS_WRITE_TIMEOUT_MS | default "3000" | quote }}
  REDIS_DIAL_TIMEOUT_MS: {{ .Values.underwriter.configmap.REDIS_DIAL_TIMEOUT_MS | default "5000" | quote }}

  # Authentication
  AUTH_ENABLED: {{ .Values.underwriter.configmap.AUTH_ENABLED | default "false" | quote }}
  AUTH_SERVICE_ADDRESS: {{ .Values.underwriter.configmap.AUTH_SERVICE_ADDRESS | default "http://plugin-access-manager-auth.midaz-plugins.svc.cluster.local.:4000" | quote }}

  # Swagger Documentation
  SWAGGER_ENABLED: {{ .Values.underwriter.configmap.SWAGGER_ENABLED | default "false" | quote }}

  # Infrastructure Boot Timeout
  INFRA_CONNECT_TIMEOUT_SEC: {{ .Values.underwriter.configmap.INFRA_CONNECT_TIMEOUT_SEC | default "30" | quote }}

  # OpenTelemetry (Observability)
  ENABLE_TELEMETRY: {{ .Values.underwriter.configmap.ENABLE_TELEMETRY | default "false" | quote }}
  OTEL_LIBRARY_NAME: {{ .Values.underwriter.configmap.OTEL_LIBRARY_NAME | default "github.com/LerianStudio/underwriter" | quote }}
  OTEL_RESOURCE_SERVICE_NAME: {{ .Values.underwriter.configmap.OTEL_RESOURCE_SERVICE_NAME | default "underwriter" | quote }}
  OTEL_RESOURCE_SERVICE_VERSION: {{ .Values.underwriter.configmap.OTEL_RESOURCE_SERVICE_VERSION | default "1.0.0" | quote }}
  OTEL_EXPORTER_OTLP_ENDPOINT: {{ .Values.underwriter.configmap.OTEL_EXPORTER_OTLP_ENDPOINT | default "" | quote }}
  OTEL_RESOURCE_DEPLOYMENT_ENVIRONMENT: {{ .Values.underwriter.configmap.OTEL_RESOURCE_DEPLOYMENT_ENVIRONMENT | default "production" | quote }}

  # Rate Limiting
  RATE_LIMIT_ENABLED: {{ .Values.underwriter.configmap.RATE_LIMIT_ENABLED | default "true" | quote }}
  RATE_LIMIT_MAX: {{ .Values.underwriter.configmap.RATE_LIMIT_MAX | default "100" | quote }}
  RATE_LIMIT_EXPIRY_SEC: {{ .Values.underwriter.configmap.RATE_LIMIT_EXPIRY_SEC | default "60" | quote }}

  # Observability & Metrics
  DB_METRICS_INTERVAL_SEC: {{ .Values.underwriter.configmap.DB_METRICS_INTERVAL_SEC | default "15" | quote }}

  # Idempotency
  IDEMPOTENCY_RETRY_WINDOW_SEC: {{ .Values.underwriter.configmap.IDEMPOTENCY_RETRY_WINDOW_SEC | default "300" | quote }}

  # Auto-generated version
  VERSION: {{ .Values.underwriter.image.tag | default .Chart.AppVersion | quote }}

  # Extra Env Vars
  {{- with .Values.underwriter.extraEnvVars }}
  {{- range . }}
  {{ .name }}: {{ .value | quote }}
  {{- end }}
  {{- end }}
{{- end }}
