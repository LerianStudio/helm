{{- if .Values.global.externalRabbitmqDefinitions.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: midaz-bootstrap-rabbitmq-definitions
  namespace: {{ .Release.Namespace }}
data:
  load_definitions.json: |
{{ .Files.Get "files/rabbitmq/load_definitions.json" | indent 4 }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: midaz-bootstrap-rabbitmq
  namespace: {{ .Release.Namespace }}
spec:
  ttlSecondsAfterFinished: 300
  completions: 1
  parallelism: 1
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-dependencies
          image: busybox:1.37
          env:
            - name: RABBITMQ_HOST
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.host | quote }}
            - name: RABBITMQ_PORT
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.portAmqp | quote }}
          command:
            - /bin/sh
            - -c
            - >
              TIMEOUT=300;
              ELAPSED=0;
              echo "Checking $RABBITMQ_HOST:$RABBITMQ_PORT...";
              while ! nc -z "$RABBITMQ_HOST" "$RABBITMQ_PORT"; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                  echo "Timeout waiting for $RABBITMQ_HOST:$RABBITMQ_PORT after ${TIMEOUT}s";
                  exit 1;
                fi;
                echo "$RABBITMQ_HOST:$RABBITMQ_PORT is not ready yet, waiting... (${ELAPSED}s/${TIMEOUT}s)";
                sleep 5;
                ELAPSED=$((ELAPSED + 5));
              done;
              echo "$RABBITMQ_HOST:$RABBITMQ_PORT is ready!";
      containers:
        - name: apply-definitions
          image: curlimages/curl:8.7.1
          command:
            - sh
            - -c
            - |
              set -e
              echo "Checking if RabbitMQ users already exist..."

              # Check if key users exist (transaction, consumer)
              TRANSACTION_EXISTS=$(curl -sf -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                "$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT/api/users/transaction" 2>/dev/null || echo "not_found")
              CONSUMER_EXISTS=$(curl -sf -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                "$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT/api/users/consumer" 2>/dev/null || echo "not_found")

              if echo "$TRANSACTION_EXISTS" | grep -q "transaction" && \
                 echo "$CONSUMER_EXISTS" | grep -q "consumer"; then
                echo "RabbitMQ definitions already applied (users transaction and consumer exist). Skipping."
                exit 0
              fi

              echo "Applying RabbitMQ definitions from file"
              curl -sf -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X POST \
                --data-binary @/definitions/load_definitions.json \
                "$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT/api/definitions"

              echo "Updating RabbitMQ user: transaction"
              curl -sf -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X PUT \
                --data "{\"password\":\"$RABBITMQ_TRANSACTION_PASS\",\"tags\":\"administrator\"}" \
                "$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT/api/users/transaction"

              echo "Updating RabbitMQ user: consumer"
              curl -sf -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X PUT \
                --data "{\"password\":\"$RABBITMQ_CONSUMER_PASS\",\"tags\":\"administrator\"}" \
                "$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT/api/users/consumer"

              echo "RabbitMQ definitions applied successfully."
          env:
            - name: RABBITMQ_PROTOCOL
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.protocol | quote }}
            - name: RABBITMQ_HOST
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.host | quote }}
            - name: RABBITMQ_PORT
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.port | quote }}
            - name: RABBITMQ_TRANSACTION_PASS
              {{- if .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name | quote }}
                  key: RABBITMQ_TRANSACTION_PASS
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.transactionPassword | quote }}
              {{- end }}
            - name: RABBITMQ_CONSUMER_PASS
              {{- if .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name | quote }}
                  key: RABBITMQ_CONSUMER_PASS
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.consumerPassword | quote }}
              {{- end }}
            - name: RABBITMQ_ADMIN_PASS
              {{- if .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name | quote }}
                  key: RABBITMQ_ADMIN_PASS
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.password | quote }}
              {{- end }}
            - name: RABBITMQ_ADMIN_USER
              {{- if .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name | quote }}
                  key: RABBITMQ_ADMIN_USER
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.username | quote }}
              {{- end }}
          volumeMounts:
            - name: definitions
              mountPath: /definitions
      volumes:
        - name: definitions
          configMap:
            name: midaz-bootstrap-rabbitmq-definitions
            items:
              - key: load_definitions.json
                path: load_definitions.json
{{- end }}