name: Release Notification

on:
  workflow_call:
    inputs:
      chart_name:
        description: 'Name of the Helm chart'
        required: true
        type: string
      chart_path:
        description: 'Path to the Helm chart directory'
        required: true
        type: string
    secrets:
      SLACK_BOT_TOKEN_HELM:
        description: 'Slack Bot Token for Helm notifications'
        required: true
      SLACK_CHANNEL_DEVOPS:
        description: 'Slack channel ID for notifications'
        required: true
      SLACK_GROUP_TECH_SUPPORT:
        description: 'Slack group ID to mention'
        required: false

jobs:
  notify:
    name: Send Slack Notification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get latest changes
        run: git pull origin ${{ github.ref_name }}

      - name: Send Slack notification
        env:
          SLACK_BOT_TOKEN_HELM: ${{ secrets.SLACK_BOT_TOKEN_HELM }}
        run: |
          # Get chart name and path from inputs
          CHART_NAME_RAW="${{ inputs.chart_name }}"
          CHART_PATH="${{ inputs.chart_path }}"

          # Format chart name for display: remove -helm suffix and convert to Title Case
          # midaz-helm -> Midaz, plugin-access-manager -> Plugin Access Manager
          CHART_NAME=$(echo "$CHART_NAME_RAW" | sed 's/-helm$//' | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++) $i=toupper(substr($i,1,1)) tolower(substr($i,2))}1')

          # Parse header and data from README version table (root README)
          # Extract section for this chart (from title to next separator)
          # Convert hyphens to spaces for matching (plugin-fees -> plugin fees)
          CHART_PATTERN=$(echo "$CHART_NAME_RAW" | sed 's/-helm$//' | sed 's/-/ /g')
          CHART_SECTION=$(awk -v chart="$CHART_PATTERN" '
            BEGIN { IGNORECASE=1; found=0 }
            tolower($0) ~ tolower("### .*" chart) { found=1 }
            found && /^-+$/ { exit }
            found { print }
          ' README.md)

          if [ -n "$CHART_SECTION" ]; then
            HEADER_LINE=$(echo "$CHART_SECTION" | grep "| Chart Version |" | head -1)
            DATA_LINE=$(echo "$CHART_SECTION" | grep -A 2 "| Chart Version |" | tail -1)
          else
            # Fallback: just get first table found
            HEADER_LINE=$(grep "| Chart Version |" README.md | head -1)
            DATA_LINE=$(grep -A 2 "| Chart Version |" README.md | tail -1)
          fi

          # Debug output
          echo "DEBUG: CHART_PATTERN=$CHART_PATTERN"
          echo "DEBUG: HEADER_LINE=$HEADER_LINE"
          echo "DEBUG: DATA_LINE=$DATA_LINE"

          # Get the latest release tag for this chart
          LATEST_TAG=$(git tag -l "${CHART_NAME_RAW}-v*" --sort=-v:refname | head -1)
          CHART_VERSION=$(echo "$LATEST_TAG" | sed "s/${CHART_NAME_RAW}-v//")
          RELEASE_URL="${{ github.server_url }}/${{ github.repository }}/releases/tag/${LATEST_TAG}"
          COMMIT_URL="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}"

          # Build README anchor URL (e.g., #midaz-helm-chart, #reporter)
          # Extract anchor from the README heading we found
          README_ANCHOR=$(echo "$CHART_SECTION" | head -1 | sed 's/^### //' | tr '[:upper:]' '[:lower:]' | sed 's/ /-/g')
          README_URL="${{ github.server_url }}/${{ github.repository }}?tab=readme-ov-file#${README_ANCHOR}"

          echo "DEBUG: LATEST_TAG=$LATEST_TAG"
          echo "DEBUG: CHART_VERSION=$CHART_VERSION"
          echo "DEBUG: README_ANCHOR=$README_ANCHOR"

          # Build native Slack table block for components (horizontal layout)
          # Uses the new table block type (introduced Aug 2025)
          # Chart Version as first column, then components
          TABLE_BLOCK=$(echo "{\"header\": \"$HEADER_LINE\", \"data\": \"$DATA_LINE\"}" | jq -c '
            # Parse columns - remove backticks and "Version" suffix from headers
            (.header | split("|") | map(gsub("^\\s+|\\s+$"; "")) | map(select(. != "")) | map(gsub(" Version$"; ""))) as $headers |
            (.data | split("|") | map(gsub("^\\s+|\\s+$"; "")) | map(select(. != "")) | map(gsub("`"; ""))) as $values |

            # Build horizontal table with ALL columns (including Chart)
            # Header row: all column names
            $headers | map({type: "raw_text", text: .}) as $header_row |

            # Data row: all version values
            $values | map({type: "raw_text", text: .}) as $data_row |

            # Build column settings (center align for all)
            $headers | map({align: "center", is_wrapped: false}) as $col_settings |

            # Build table block
            {
              type: "table",
              column_settings: $col_settings,
              rows: [$header_row, $data_row]
            }
          ')

          echo "DEBUG: TABLE_BLOCK=$TABLE_BLOCK"

          # Get mention group ID and build context
          MENTION_GROUP="${{ secrets.SLACK_GROUP_TECH_SUPPORT }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M UTC")
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          WORKFLOW_NUM="${{ github.run_number }}"

          if [ -n "$MENTION_GROUP" ]; then
            CONTEXT_TEXT=":clock1: ${TIMESTAMP} | Workflow: <${WORKFLOW_URL}|#${WORKFLOW_NUM}> | cc: <!subteam^${MENTION_GROUP}>"
          else
            CONTEXT_TEXT=":clock1: ${TIMESTAMP} | Workflow: <${WORKFLOW_URL}|#${WORKFLOW_NUM}>"
          fi

          # Build Slack payload with blocks at root level (avoids "show more" collapse)
          # Use attachment only for the color bar indicator
          SLACK_PAYLOAD=$(jq -n \
            --arg channel "${{ secrets.SLACK_CHANNEL_DEVOPS }}" \
            --arg chart_name "$CHART_NAME" \
            --arg chart_version "$CHART_VERSION" \
            --arg release_url "$RELEASE_URL" \
            --arg commit_url "$COMMIT_URL" \
            --arg readme_url "$README_URL" \
            --argjson table_block "$TABLE_BLOCK" \
            --arg context "$CONTEXT_TEXT" \
            '{
              channel: $channel,
              blocks: [
                {type: "header", text: {type: "plain_text", text: ("New Release: " + $chart_name + " Helm Chart :rocket:"), emoji: true}},
                $table_block,
                {type: "actions", elements: [
                  {type: "button", text: {type: "plain_text", text: "View Release", emoji: true}, url: $release_url, style: "primary"},
                  {type: "button", text: {type: "plain_text", text: "View Versions", emoji: true}, url: $readme_url},
                  {type: "button", text: {type: "plain_text", text: "View Commit", emoji: true}, url: $commit_url}
                ]},
                {type: "context", elements: [{type: "mrkdwn", text: $context}]}
              ],
              attachments: [{
                color: "#36a64f",
                blocks: []
              }]
            }')

          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $SLACK_BOT_TOKEN_HELM" \
            -H "Content-type: application/json; charset=utf-8" \
            --data "$SLACK_PAYLOAD" \
            "https://slack.com/api/chat.postMessage")

          if echo "$RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "Slack notification sent successfully"
          else
            echo "::warning::Failed to send Slack notification"
            echo "$RESPONSE" | jq .
          fi
