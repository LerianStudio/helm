{{- if and .Values.externalRabbitmqDefinitions.enabled (not .Values.rabbitmq.enabled) }}
{{- /* Bootstrap job is only for external RabbitMQ. When rabbitmq.enabled=true, definitions are auto-loaded via customConfig */ -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: fetcher-bootstrap-rabbitmq-definitions
  namespace: {{ .Release.Namespace }}
data:
  load_definitions.json: |
{{ .Files.Get "files/rabbitmq/load_definitions.json" | indent 4 }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fetcher-bootstrap-rabbitmq
  namespace: {{ .Release.Namespace }}
spec:
  ttlSecondsAfterFinished: 300
  completions: 1
  parallelism: 1
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-dependencies
          image: busybox:1.37
          env:
            - name: RABBITMQ_HOST
              value: {{ .Values.externalRabbitmqDefinitions.connection.host | quote }}
            - name: RABBITMQ_PORT
              value: {{ .Values.externalRabbitmqDefinitions.connection.portAmqp | quote }}
          command:
            - /bin/sh
            - -c
            - >
              TIMEOUT=300;
              ELAPSED=0;
              echo "Checking $RABBITMQ_HOST:$RABBITMQ_PORT...";
              while ! nc -z "$RABBITMQ_HOST" "$RABBITMQ_PORT"; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                  echo "Timeout waiting for $RABBITMQ_HOST:$RABBITMQ_PORT after ${TIMEOUT}s";
                  exit 1;
                fi;
                echo "$RABBITMQ_HOST:$RABBITMQ_PORT is not ready yet, waiting... (${ELAPSED}s/${TIMEOUT}s)";
                sleep 5;
                ELAPSED=$((ELAPSED + 5));
              done;
              echo "$RABBITMQ_HOST:$RABBITMQ_PORT is ready!";
      containers:
        - name: apply-definitions
          image: curlimages/curl:8.7.1
          command:
            - sh
            - -c
            - |
              set -e

              # Build base URL - omit port for default HTTPS (443) or HTTP (80)
              if [ "$RABBITMQ_PROTOCOL" = "https" ] && [ "$RABBITMQ_PORT" = "443" ]; then
                BASE_URL="$RABBITMQ_PROTOCOL://$RABBITMQ_HOST"
              elif [ "$RABBITMQ_PROTOCOL" = "http" ] && [ "$RABBITMQ_PORT" = "80" ]; then
                BASE_URL="$RABBITMQ_PROTOCOL://$RABBITMQ_HOST"
              else
                BASE_URL="$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT"
              fi

              echo "=== Fetcher RabbitMQ Bootstrap ==="
              echo "API URL: $BASE_URL"
              echo ""

              echo "Checking if RabbitMQ definitions already exist..."

              # Check if plugin user already exists
              PLUGIN_EXISTS=$(curl -sSk -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                "$BASE_URL/api/users/plugin" 2>/dev/null || echo "not_found")

              # Check if fetcher queue exists
              QUEUE_EXISTS=$(curl -sSk -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                "$BASE_URL/api/queues/%2F/fetcher.generate-fetcher.queue" 2>/dev/null || echo "not_found")

              if echo "$PLUGIN_EXISTS" | grep -q '"name":"plugin"' && \
                 echo "$QUEUE_EXISTS" | grep -q '"name":"fetcher.generate-fetcher.queue"'; then
                echo "RabbitMQ definitions already applied (user plugin and fetcher queues exist). Skipping."
                exit 0
              fi

              echo "Applying RabbitMQ definitions from file..."
              HTTP_CODE=$(curl -sSk -o /tmp/response.txt -w "%{http_code}" \
                -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X POST \
                --data-binary @/definitions/load_definitions.json \
                "$BASE_URL/api/definitions")
              if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
                echo "Error applying definitions (HTTP $HTTP_CODE):"
                cat /tmp/response.txt
                exit 1
              fi
              echo "Done."

              echo "Updating RabbitMQ user: plugin..."
              HTTP_CODE=$(curl -sSk -o /tmp/response.txt -w "%{http_code}" \
                -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X PUT \
                --data "{\"password\":\"$RABBITMQ_PLUGIN_PASS\",\"tags\":\"administrator\"}" \
                "$BASE_URL/api/users/plugin")
              if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
                echo "Error updating plugin user (HTTP $HTTP_CODE):"
                cat /tmp/response.txt
                exit 1
              fi
              echo "Done."

              echo ""
              echo "=== Fetcher RabbitMQ Bootstrap completed successfully ==="
          env:
            - name: RABBITMQ_PROTOCOL
              value: {{ .Values.externalRabbitmqDefinitions.connection.protocol | quote }}
            - name: RABBITMQ_HOST
              value: {{ .Values.externalRabbitmqDefinitions.connection.host | quote }}
            - name: RABBITMQ_PORT
              value: {{ .Values.externalRabbitmqDefinitions.connection.port | quote }}
            - name: RABBITMQ_PLUGIN_PASS
              {{- if .Values.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name | quote }}
                  key: RABBITMQ_DEFAULT_PASS
              {{- else }}
              value: {{ .Values.externalRabbitmqDefinitions.appCredentials.pluginPassword | quote }}
              {{- end }}
            - name: RABBITMQ_ADMIN_PASS
              {{- if .Values.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name | quote }}
                  key: RABBITMQ_ADMIN_PASS
              {{- else }}
              value: {{ .Values.externalRabbitmqDefinitions.rabbitmqAdminLogin.password | quote }}
              {{- end }}
            - name: RABBITMQ_ADMIN_USER
              {{- if .Values.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name | quote }}
                  key: RABBITMQ_ADMIN_USER
              {{- else }}
              value: {{ .Values.externalRabbitmqDefinitions.rabbitmqAdminLogin.username | quote }}
              {{- end }}
          volumeMounts:
            - name: definitions
              mountPath: /definitions
      volumes:
        - name: definitions
          configMap:
            name: fetcher-bootstrap-rabbitmq-definitions
            items:
              - key: load_definitions.json
                path: load_definitions.json
{{- end }}
