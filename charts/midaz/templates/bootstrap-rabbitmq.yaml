{{- if .Values.global.externalRabbitmqDefinitions.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: midaz-bootstrap-rabbitmq-definitions
  namespace: {{ .Release.Namespace }}
data:
  load_definitions.json: |
{{ .Files.Get "files/rabbitmq/load_definitions.json" | indent 4 }}
---
apiVersion: batch/v1
kind: Job
metadata:
  name: midaz-bootstrap-rabbitmq
  namespace: {{ .Release.Namespace }}
spec:
  ttlSecondsAfterFinished: 300
  completions: 1
  parallelism: 1
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-dependencies
          image: busybox:1.37
          env:
            - name: RABBITMQ_HOST
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.host | quote }}
            - name: RABBITMQ_PORT
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.portAmqp | quote }}
          command:
            - /bin/sh
            - -c
            - >
              TIMEOUT=300;
              ELAPSED=0;
              echo "Checking $RABBITMQ_HOST:$RABBITMQ_PORT...";
              while ! nc -z "$RABBITMQ_HOST" "$RABBITMQ_PORT"; do
                if [ $ELAPSED -ge $TIMEOUT ]; then
                  echo "Timeout waiting for $RABBITMQ_HOST:$RABBITMQ_PORT after ${TIMEOUT}s";
                  exit 1;
                fi;
                echo "$RABBITMQ_HOST:$RABBITMQ_PORT is not ready yet, waiting... (${ELAPSED}s/${TIMEOUT}s)";
                sleep 5;
                ELAPSED=$((ELAPSED + 5));
              done;
              echo "$RABBITMQ_HOST:$RABBITMQ_PORT is ready!";
      containers:
        - name: apply-definitions
          image: curlimages/curl:8.7.1
          command:
            - sh
            - -c
            - |
              set -e

              # Build base URL - omit port for default HTTPS (443) or HTTP (80)
              if [ "$RABBITMQ_PROTOCOL" = "https" ] && [ "$RABBITMQ_PORT" = "443" ]; then
                BASE_URL="$RABBITMQ_PROTOCOL://$RABBITMQ_HOST"
              elif [ "$RABBITMQ_PROTOCOL" = "http" ] && [ "$RABBITMQ_PORT" = "80" ]; then
                BASE_URL="$RABBITMQ_PROTOCOL://$RABBITMQ_HOST"
              else
                BASE_URL="$RABBITMQ_PROTOCOL://$RABBITMQ_HOST:$RABBITMQ_PORT"
              fi

              echo "=== RabbitMQ Bootstrap ==="
              echo "API URL: $BASE_URL"
              echo ""

              echo "Checking if RabbitMQ users already exist..."

              # Check if key users exist (transaction, consumer)
              TRANSACTION_EXISTS=$(curl -sSk -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                "$BASE_URL/api/users/transaction" 2>/dev/null || echo "not_found")
              CONSUMER_EXISTS=$(curl -sSk -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                "$BASE_URL/api/users/consumer" 2>/dev/null || echo "not_found")

              if echo "$TRANSACTION_EXISTS" | grep -q '"name":"transaction"' && \
                 echo "$CONSUMER_EXISTS" | grep -q '"name":"consumer"'; then
                echo "RabbitMQ definitions already applied (users transaction and consumer exist). Skipping."
                exit 0
              fi

              echo "Applying RabbitMQ definitions from file..."
              HTTP_CODE=$(curl -sSk -o /tmp/response.txt -w "%{http_code}" \
                -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X POST \
                --data-binary @/definitions/load_definitions.json \
                "$BASE_URL/api/definitions")
              if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
                echo "Error applying definitions (HTTP $HTTP_CODE):"
                cat /tmp/response.txt
                exit 1
              fi
              echo "Done."

              echo "Updating RabbitMQ user: transaction..."
              HTTP_CODE=$(curl -sSk -o /tmp/response.txt -w "%{http_code}" \
                -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X PUT \
                --data "{\"password\":\"$RABBITMQ_TRANSACTION_PASS\",\"tags\":\"administrator\"}" \
                "$BASE_URL/api/users/transaction")
              if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
                echo "Error updating transaction user (HTTP $HTTP_CODE):"
                cat /tmp/response.txt
                exit 1
              fi
              echo "Done."

              echo "Updating RabbitMQ user: consumer..."
              HTTP_CODE=$(curl -sSk -o /tmp/response.txt -w "%{http_code}" \
                -u "$RABBITMQ_ADMIN_USER:$RABBITMQ_ADMIN_PASS" \
                -H "content-type: application/json" \
                -X PUT \
                --data "{\"password\":\"$RABBITMQ_CONSUMER_PASS\",\"tags\":\"administrator\"}" \
                "$BASE_URL/api/users/consumer")
              if [ "$HTTP_CODE" -lt 200 ] || [ "$HTTP_CODE" -ge 300 ]; then
                echo "Error updating consumer user (HTTP $HTTP_CODE):"
                cat /tmp/response.txt
                exit 1
              fi
              echo "Done."

              echo ""
              echo "=== RabbitMQ Bootstrap completed successfully ==="
          env:
            - name: RABBITMQ_PROTOCOL
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.protocol | quote }}
            - name: RABBITMQ_HOST
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.host | quote }}
            - name: RABBITMQ_PORT
              value: {{ .Values.global.externalRabbitmqDefinitions.connection.port | quote }}
            - name: RABBITMQ_TRANSACTION_PASS
              {{- if .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name | quote }}
                  key: RABBITMQ_DEFAULT_PASS
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.transactionPassword | quote }}
              {{- end }}
            - name: RABBITMQ_CONSUMER_PASS
              {{- if .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.useExistingSecret.name | quote }}
                  key: RABBITMQ_CONSUMER_PASS
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.appCredentials.consumerPassword | quote }}
              {{- end }}
            - name: RABBITMQ_ADMIN_PASS
              {{- if .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name | quote }}
                  key: RABBITMQ_ADMIN_PASS
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.password | quote }}
              {{- end }}
            - name: RABBITMQ_ADMIN_USER
              {{- if .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name }}
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.useExistingSecret.name | quote }}
                  key: RABBITMQ_ADMIN_USER
              {{- else }}
              value: {{ .Values.global.externalRabbitmqDefinitions.rabbitmqAdminLogin.username | quote }}
              {{- end }}
          volumeMounts:
            - name: definitions
              mountPath: /definitions
      volumes:
        - name: definitions
          configMap:
            name: midaz-bootstrap-rabbitmq-definitions
            items:
              - key: load_definitions.json
                path: load_definitions.json
{{- end }}